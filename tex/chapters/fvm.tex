\chapter{The Finite Volume Method}\label{ch:fvm}
In this section, we present the finite volume method (FVM) for solving nonlinear systems of balance laws, specifically focusing on the shallow water equations (SWE).
Nonlinear problems are more challenging than linear problems, as stability and convergence theory are more difficult to establish.
In particular, when dealing with hyperbolic systems such as the SWE, the presence of discontinuities such as shock waves, hydraulic jumps, and rarefaction waves requires special treatment.
Our focus is on discontinuous solutions, which can accurately capture these shocks and other discontinuities.
The FVM provides a framework for dealing with such solutions in a robust and efficient manner.
Unlike traditional methods, which may struggle to capture sharp gradients or discontinuities, FVM inherently incorporates a mechanism to resolve such features by solving the local Riemann problem at the interfaces between computational cells.
This characteristic makes it particularly well-suited for problems involving abrupt changes in the flow, such as those encountered in the modeling of floods, tsunamis, or dam breaks.

The approach described here is based on the work of LeVeque~\cite{LeVeque2002}, who developed a framework for using the FVM in the context of hyperbolic systems of PDEs.
Additionally, this work is informed by a special course on the FVM~\cite{special_course}, which covered its application to the 1D shallow water equations.
The key idea is to discretize the computational domain into small cells or control volumes and compute the fluxes across the boundaries of these cells.
The solution within each cell is then updated using the information from neighboring cells, ensuring that conservation laws are satisfied.
By solving the local Riemann problem at the cell interfaces, the FVM can accurately capture discontinuities and preserve the sharp transitions between different flow regimes.
In addition to its ability to handle discontinuities, the FVM also has several other advantages, such as its ability to conserve mass, momentum, and energy in a discrete sense.
This property is crucial when solving balance laws, as it ensures that the physical conservation laws are respected even at the discrete level.
The method is also highly flexible, allowing for the use of unstructured grids, which can be beneficial for complex geometries and irregular domains.
Despite its advantages, the FVM also has limitations. The accuracy of the method depends heavily on the choice of numerical flux function and the resolution of the computational grid.
In the presence of strong discontinuities, additional techniques such as limiters or high-order schemes may be required to maintain stability and avoid spurious oscillations.
Furthermore, while the FVM is well-suited for handling hyperbolic problems, it may not be as effective for problems with smooth solutions or for capturing fine-scale features in the solution without sufficient grid resolution.

In this chapter, we derive the finite volume scheme for the 1D SWE and extend it to 2D in cartesian coordinates.
We introduce the MUSCL (monotonic upstream-centered scheme for conservation laws) scheme for higher-order accuracy and discuss the FVM for the 1D LSWE in spherical coordinates.
Additionally, we examine the Riemann problem, including the dam break problem, and present numerical flux functions for solving the local Riemann problem at cell interfaces.

\section{The Finite Volume Method for the 1D Shallow Water Equations}\label{sec:FVM_1D_SWE}
We begin by introducing the FVM for the SWE in one spatial dimension.
Specifically, we work in the \(x,t\)-plane, discretizing the domain into finite control volumes or cells.
In \autoref{ch:theory}, we derived the integral form for a single control volume \(V = [x_L, x_R] \times [t_1, t_2]\).
Here, we extend this approach to a global domain consisting of multiple cells.
To accommodate this, we update the notation: \(x_{i-1/2}\) and \(x_{i+1/2}\) denote the cell interfaces, while \(t_n\) and \(t_{n+1}\) represent the time levels.
The control volume for cell $i$ at time level $n$ is defined as:
\begin{align*}
    V_i^n = [x_{i-1/2}, x_{i+1/2}] \times [t_n, t_{n+1}],
\end{align*}
where $\Delta x = x_{i+1/2} - x_{i-1/2}$ is the length of the cell and $\Delta t = t_{n+1} - t_n$ is the time step size.
The cell $V_i^n$ is illustrated in Figure~\ref{fig:control_volume_V_i_n}.
\begin{figure}[H]
    \centering
    \includegraphics[width=0.4\textwidth]{C:/Users/Matteo/Shallow-Water-Equations/tex/figs/control_volume_V_i_n.png}
    \caption{Illustration of the control volume $V_i^n$ in the $x,t$ plane.}\label{fig:control_volume_V_i_n}
\end{figure}
The grid can be uniform or non-uniform, depending on the application.
For now, we will assume a uniform grid for simplicity.
The finite volume formula is derived from the integral form of the 1D SWE~\eqref{eq:integral_form_1D_final}.
The integral form stated in the new variables ($x_{i-1/2}$, $x_{i+1/2}$, $t_n$, $t_{n+1}$) over the cell $V_i^n$ is given by
\begin{equation}\label{eq:integral_form_1D_SWE_new_variables}
    \begin{aligned}
    \int_{x_{i-1/2}}^{x_{i+1/2}} \mathbf{U}(x,t_{n+1}) \text{ d}x &= 
    \int_{x_{i-1/2}}^{x_{i+1/2}} \mathbf{U}(x,t_n) \text{ d}x + 
    \int_{t_n}^{t_{n+1}} \mathbf{F}(\mathbf{U}(x_{i-1/2}, t)) \text{ d}t -
    \int_{t_n}^{t_{n+1}} \mathbf{F}(\mathbf{U}(x_{i+1/2}, t)) \text{ d}t \\
    &+
    \int_{t_n}^{t_{n+1}} \int_{x_{i-1/2}}^{x_{i+1/2}} \mathbf{S(U)}(x,t) \text{d}x \text{d}t.
    \end{aligned}
\end{equation}
We divide the integral form~\eqref{eq:integral_form_1D_SWE_new_variables} by the cell length $\Delta x$ to obtain
\begin{align*}
    \frac{1}{\Delta x} \int_{x_{i-1/2}}^{x_{i+1/2}} \mathbf{U}(x,t_{n+1}) \text{ d}x &= \frac{1}{\Delta x} \int_{x_{i-1/2}}^{x_{i+1/2}} \mathbf{U}(x,t_n) \text{ d}x\\
    & - \frac{\Delta t}{\Delta x} \left[ \frac{1}{\Delta t} \int_{t_n}^{t_{n+1}} \mathbf{F}(\mathbf{U}(x_{i+1/2}, t)) \text{ d}t
    - \frac{1}{\Delta t} \int_{t_n}^{t_{n+1}} \mathbf{F}(\mathbf{U}(x_{i-1/2}, t)) \text{ d}t \right] \\
    &+ \frac{\Delta t}{\Delta x \Delta t} \int_{x_{i-1/2}}^{x_{i+1/2}} \int_{t_n}^{t_{n+1}} \mathbf{S(U)}(x,t) \text{d}x \text{d}t.
\end{align*}
To simplify the numerical implementation, we introduce cell-averaged values.
These are defined as the averages of the conserved variables $\mathbf{U}$, the fluxes $\mathbf{F}$, and the source terms $\mathbf{S}$ over the volume $V_i^n$.
This leads to the explicit conservative form of the finite volume scheme:
\begin{align}\label{eq:explicit_conservative_1D_SWE}
    \mathbf{U}_i^{n+1} = \mathbf{U}_i^n - \frac{\Delta t}{\Delta x} \left( \mathbf{F}_{i+1/2}^n - \mathbf{F}_{i-1/2}^n \right) + \Delta t \mathbf{S}_i.
\end{align}
%The formula~\eqref{eq:explicit_conservative_1D_SWE} is referred to as a finite volume scheme.
The value $\mathbf{U}_i^n$ is the average value over the $i$-th cell at time $t_n$:
\begin{align*}
    \mathbf{U}_i^n = \frac{1}{\Delta x} \int_{x_{i-1/2}}^{x_{i+1/2}} \mathbf{U}(x,t_n) \text{ d}x,
\end{align*}
also known as the cell average.
The flux $\mathbf{F}_{i-1/2}^n$ is the average flux across the line $x = x_{i-1/2}$ from time $t_n$ to $t_{n+1}$:
\begin{align*}
    \mathbf{F}_{i-1/2}^n = \frac{1}{\Delta t} \int_{t_n}^{t_{n+1}} \mathbf{F}(\mathbf{U}(x_{i-1/2},t)) \text{ d}t,
\end{align*}
and correspondingly the flux $\mathbf{F}_{i+1/2}^n$ is the average flux across the line $x = x_{i+1/2}$ from time $t_n$ to $t_{n+1}$:
\begin{align*}
    \mathbf{F}_{i+1/2}^n = \frac{1}{\Delta t} \int_{t_n}^{t_{n+1}} \mathbf{F}(\mathbf{U}(x_{i+1/2},t)) \text{ d}t.
\end{align*}
The source term $\mathbf{S}_i$ is the average source term over the $i$-th cell at time $t_n$:
\begin{align*}
    \mathbf{S}_i &= \frac{1}{\Delta t \Delta x} \int_{t_n}^{t_{n+1}} \int_{x_{i-1/2}}^{x_{i+1/2}} \mathbf{S}(x,t) \text{ d}x\text{d}t.
\end{align*}
The values are illustrated in Figure~\ref{fig:10_3}.
\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\textwidth]{C:/Users/Matteo/Shallow-Water-Equations/tex/figs/fvm_grid_new.png}
    \caption{Illustration of the grid for the 1D SWE.}\label{fig:10_3}
\end{figure}
The central idea of the FVM is to define the numerical flux $\mathbf{F}_{i+1/2}^n$, at the cell interface, as a function of the cell averages $\mathbf{U}_i^n$ and $\mathbf{U}_{i+1}^n$, since the solution is known only in terms of these cell averages.
Consequently, the FVM does not provide pointwise values of the solution, i.e., $\mathbf{U}(x,t)$, but instead gives cell-averaged values, $\mathbf{U}_i^n$, over the control volume.
One of the main challenges in the FVM is to determine appropiate numerical flux functions that, based on the available cell averages, can reasonably approximate the fluxes at the cell interfaces. 
Later in the thesis, we will consider several numerical flux functions that can be used to solve the local Riemann problem at the cell interfaces.

The FVM is closely related to the finite difference method (FDM), but they differs as the FVM is based on the integral form of the conservation laws.
Where the FDM tends to break down near discontinuities in the solution, the FVM is more suited, since it is based on the integral form of the conservation laws.
The key distinction between the FVM and the FDM lies in their formulation: while the FVM is based on the integral conservation over finite volumes, the FDM is based on satisfying the differential equations point-wise at mesh points.
Similarly, the FVM and the finite element method (FEM) differ in some of their principles and applications.
In the FVM, the solution is represented by cell averages, and the integral formulation defines how the differential equations are satisfied at the local level.
In contrast, the FEM approximates the solution using globally defined piece-wise continuous basis functions.
Derived from the weak (integral) from of a PDE, it is particularly effective for solving problems with complex geometries.
%Like the FVM, the FEM divides the domain into smaller elements, but approximates the solution using interpolation functions.
%The FEM scheme is derived from a weak form (integral form).

\newpage
\section{The Finite Volume Method for the 2D Shallow Water Equations}
We now extend the FVM to two spatial dimensions, meaning we consider both the $x-$ and $y-$direction.
Consider the 2D SWE in vector form~\eqref{eq:vector_form_2D} with the source term defined such that $\mathbf{S(U)} = 0$:
\begin{align}\label{eq:2D_SWE}
    \mathbf{U}_t + \mathbf{F(U)}_x + \mathbf{G(U)}_y = 0.
\end{align}
Following the methods outlined in~\cite{Toro2009-Riemann}, an explicit finite volume scheme to solve~\eqref{eq:2D_SWE} is given by
\begin{align}\label{eq:fvm_scheme_2D_unsplit}
    \mathbf{U}_{i,j}^{n+1} = \mathbf{U}_{i,j}^n - \frac{\Delta t}{\Delta x}(\mathbf{F}_{i+1/2,j} - \mathbf{F}_{i-1/2,j}) - \frac{\Delta t}{\Delta y}(\mathbf{G}_{i,j+1/2} - \mathbf{G}_{i,j-1/2}).
\end{align}
This is the unsplit finite volume method, meaning that, in a single step, the cell average $\mathbf{U}_{i,j}^n$ in cell $V_{i,j}$ is updated using the fluxes from all intercell boundaries.
This means, that in each time step, we need to solve the Riemann problem at all cell interfaces, and then use the fluxes to update the cell averages.
The fluxes $\mathbf{F}_{i-1/2,j}$ and $\mathbf{F}_{i+1/2,j}$ are the average fluxes across the lines $x = x_{i-1/2}$ and $x = x_{i+1/2}$.
Correspondingly, the fluxes $\mathbf{G}_{i,j-1/2}$ and $\mathbf{G}_{i,j+1/2}$ are the average fluxes across the lines $y = y_{j-1/2}$ and $y = y_{j+1/2}$.
We work on a domain discretized into rectangular cells of size $\Delta x \times \Delta y$, where $\Delta x = x_{j + 1/2} - x_{j - 1/2} $ and $\Delta y = y_{j + 1/2} - y_{j - 1/2}$.
The fluxes are illustrated in \autoref{fig:FVM_2D_fluxes}.
\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\textwidth]{C:/Users/Matteo/Shallow-Water-Equations/figs/FVM_2D_fluxes.png}
    \caption{Illustration of the fluxes for the 2D SWE.}\label{fig:FVM_2D_fluxes}
\end{figure}
When using the simultaneous update scheme~\eqref{eq:fvm_scheme_2D_unsplit}, we must consider potential stability issues.
To address this, several methods can be employed.

The first method we consider is the weighted average flux (WAF) scheme.
The basic WAF scheme, without any nonlinear total variation diminishing (TVD) modification, is prone to oscillations.
To mitigate this, a TVD constraint can be enforced.
A numerical method $U_{i,j}^{n+1} $ is called TVD if it satisfies the following condition~\cite{LeVeque_1992}:
\begin{align}
    TV(U^{n+1}) \leq TV(U^n),
\end{align}
for all grid functions $U^n$. 
For a discrete function $U_{i,j}$ defined on a grid $i = 0,1, \dots, N$ and $j=0,1, \dots, N$, the total variation $TV(U)$ is defined as
\begin{align}
    TV(U) = \sum_{i=0}^{N-1} \sum_{j=0}^{N-1}  |U_{i+1,j} - U_{i,j}| + |U_{i,j+1} - U_{i,j}|.
\end{align}
The total variation measures the sum of the absolute differences between neighboring grid points.
A TVD scheme ensures that the total variation of the solution does not increase in time, which is crucial for maintaining stability and preventing oscillations.
The TVD property is used in shock-capturing schemes to prevent nonphysical oscillations near discontinuities, helping to accurately capture the shock location.
To achieve the TVD condition, additional constraints are imposed on the numerical flux or reconstruction process, often through the use of slope limiters.
A limiter function is a technique used to reduce oscillations in the solution, especially near sharp edges or discontinuities, such as shock waves.
For this project, we use the minmod limiter, defined as
\begin{equation*}
    \text{minmod}(a,b) = 
    \begin{cases}
        \max(0, \min(a,b)) & \text{if } a > 0 \\
        \min(0, \max(a,b)) & \text{if } a < 0. 
    \end{cases}
\end{equation*}
Another method we consider is the MUSCL scheme.
This method is second-order accurate in both time and space, while the WAF scheme is second-order accurate in space but relies on the time-stepping scheme for temporal accuracy.
The MUSCL scheme, combined with slope limiters, ensures the solution satisfies the TVD constraint, effectively preventing oscillations that could occur with high-order spatial discretization near shocks, discontinuities, or sharp changes in the solution.
The key idea in MUSCL is that, instead of using cell averages as in the 1D FVM, we reconstruct the solution in each cell using piecewise linear functions.
This reconstruction provides a higher-order representation of the solution within each cell.
In this project, we use the MUSCL scheme with the TVD criteria to ensure smooth and stable solutions.

\section{The Finite Volume Method for the spherical 1D Linearized Shallow Water Equations}
In this section, we derive the FVM for the 1D LSWE on a sphere, by following the same method as in \autoref{sec:FVM_1D_SWE}.
We begin by stating the integral form of the 1D LSWE in spherical coordinates on a global domain, meaning we now consider a control volume given by 
\begin{align*}
    V_i^n = [\theta_{i-1/2}, \theta_{i+1/2}] \times [t_n, t_{n+1}],
\end{align*}
where $\Delta \theta = \theta_{i+1/2} - \theta_{i-1/2}$ is the length of the cell and $\Delta t = t_{n+1} - t_n$ is the time step size.
We rewrite the previous derived integral form~\eqref{eq:integral_form_spherical_1D_final} to be in global variables:
\begin{align}\label{eq:integral_form_spherical_1D_final_global}
    \int_{\theta_{i-1/2}}^{\theta_{i+1/2}} \mathbf{W}(\theta, t_{n+1}) \text{ d}\theta = \int_{\theta_{i-1/2}}^{\theta_{i+1/2}} \mathbf{W}(\theta, t_n) \text{ d}\theta
    - \mathbf{A} \left( \int_{t_n}^{t_{n+1}} \mathbf{W}(\theta_{i+1/2}, t) \text{ d}t - \int_{t_n}^{t_{n+1}} \mathbf{W}(\theta_{i-1/2}, t) \text{ d}t \right).
\end{align}
We divide the integral form~\eqref{eq:integral_form_spherical_1D_final_global} with the cell length $\Delta \theta$ to obtain
\begin{align*}
    \frac{1}{\Delta \theta} \int_{\theta_{i-1/2}}^{\theta_{i+1/2}} \mathbf{W}(\theta, t_{n+1}) \text{ d}\theta &=
    \frac{1}{\Delta \theta} \int_{\theta_{i-1/2}}^{\theta_{i+1/2}} \mathbf{W}(\theta, t_n) \text{ d}\theta \\
    &- \frac{\Delta t}{\Delta \theta} \mathbf{A} \left( \frac{1}{\Delta t} \int_{t_n}^{t_{n+1}} \mathbf{W}(\theta_{i-1/2}, t) \text{ d}t - \frac{1}{\Delta t} \int_{t_n}^{t_{n+1}} \mathbf{W}(\theta_{i+1/2}, t) \text{ d}t\right) .
\end{align*}
Averaging over the terms for a finite volume gives the first-order explicit time-stepping finite volume scheme:
\begin{align}
    \mathbf{W}_i^{n+1} = \mathbf{W}_i^n - \frac{\Delta t}{\Delta \theta} (\mathbf{F}_{i+1/2}^n - \mathbf{F}_{i-1/2}^n).
\end{align}
The scheme uses the cell averages:
\begin{align*}
    \mathbf{W}_i^{n} = \frac{1}{\Delta \theta} \int_{\theta_{i-1/2}}^{\theta_{i+1/2}} \mathbf{W}(\theta, t_n) \text{ d}\theta
\end{align*}
The flux $\mathbf{F}_{i-1/2}^n$ is the average flux across the line $\theta = \theta_{i-1/2}$ from time $t_n$ to $t_{n+1}$:
\begin{align*}
    \mathbf{F}_{i-1/2}^n = \frac{1}{\Delta t} \mathbf{A} \int_{t_n}^{t_{n+1}} (\mathbf{W}(\theta_{i-1/2}, t)) \text{ d}t,
\end{align*}
and correspondingly the flux $\mathbf{F}_{i+1/2}^n$ is the average flux across the line $\theta = \theta_{i+1/2}$ from time $t_n$ to $t_{n+1}$:
\begin{align*}
    \mathbf{F}_{i+1/2}^n = \frac{1}{\Delta t} \mathbf{A} \int_{t_n}^{t_{n+1}} (\mathbf{W}(\theta_{i+1/2}, t)) \text{ d}t.
\end{align*}
%The FVM scheme can be written as 
%\begin{align*}
%    \mathbf{W}_i^{n+1} = \mathbf{W}_i^n - \frac{\Delta t}{\Delta \theta} (\mathbf{A}_{i+1/2}^n - \mathbf{A}_{i-1/2}^n) + \Delta t \mathbf{S}_i,
%\end{align*}
%where $\mathbf{W} = \begin{bmatrix} h \\ u \end{bmatrix}$, $\mathbf{A}_{i+1/2}^n$ is the numerical flux at the cell interface $\theta_{i+1/2}$, and $\mathbf{S} = \begin{bmatrix} 0 \\ fu \end{bmatrix}.$ 
%En eller anden motivation for at bruge denne her metode?? 

\subsection*{The Explicit Runge-Kutta 4th Order Method}
We will now introduce how we can use the explicit Runge-Kutta 4th order (ERK4) method to solve the 1D spherical LSWE.
The ERK4 method solves the general initial value problem (IVP) for ordinary differential equations (ODEs):
\begin{align}\label{eq:IVP}
    \frac{d y(t)}{dt} = f(y(t), t), \quad y(t_0) = y_0.
\end{align}
To solve the IVP~\eqref{eq:IVP} using ERK4 we choose a step size $\Delta t > 0$ and define the update formula:
\begin{subequations}
    \begin{align*}
        y_{n+1} &= y_n + \frac{\Delta t}{6} (k_1 + 2k_2 + 2k_3 + k_4), \\
        t_{n+1} &= t_n + \Delta t,     \quad n = 0,1, \dots, N-1,
    \end{align*}
\end{subequations}
where the stages $k_1, k_2, k_3$ and $k_4$ are given by~\cite{RK4}:
\begin{subequations}
    \begin{align*}
        k_1 &= f(t_n, y_n), \\
        k_2 &= f(t_n + \frac{\Delta t}{2}, y_n + \frac{\Delta t}{2} k_1), \\
        k_3 &= f(t_n + \frac{\Delta t}{2}, y_n + \frac{\Delta t}{2} k_2), \\
        k_4 &= f(t_n + \Delta t, y_n + \Delta t k_3).
    \end{align*}
\end{subequations}
This means that to use ERK4 to solve the 1D spherical LSWE, we must bring the equations in the same form as the IVP~\eqref{eq:IVP}.
Recall, that the 1D LSWE in spherical coordinates are given by
\begin{equation}\label{eq:linearized_LSWE_spherical}
    \left.
    \begin{aligned}
        \frac{\partial h'}{\partial t} &= -\frac{h_0}{r \cos\phi} \frac{\partial u}{\partial \theta}, \\
        \frac{\partial u}{\partial t} &= -\frac{g}{r \cos\phi}  \frac{\partial h'}{\partial \theta}, 
    \end{aligned}
    \right\}
\end{equation}
where $h'$ is the perturbation in water height, $u$ is the velocity in the $\theta-$direction, $h_0$ is the mean water depth, $g$ is the gravitational acceleration, $r$ is the Earth's radius, and $\phi$ is the fixed latitude.
Since the ERK4 method solves ODEs, and the LSWE are PDEs, we must use the method of lines (MOL) to bring the LSWE in the form of the IVP~\eqref{eq:IVP}.
The MOL is a technique for solving PDEs by discretizing all variables but one (usually time), transforming the PDE into a system of ODEs~\cite{mol}.
The system of ODEs can then be solved using standard ODE solvers, such as the ERK4 method.
We discretize the spatial dimension $\theta$ into $N$ cells, and approximate the spatial derivatives using central differences:
\begin{equation}\label{eq:discretized_LSWE_spherical}
    \left.
    \begin{aligned}
        \frac{\partial u}{\partial \theta} &\approx \frac{u_{i+1} - u_{i-1}}{2 \Delta \theta}, \\
        \frac{\partial h'}{\partial \theta} &\approx \frac{h'_{i+1} - h'_{i-1}}{2 \Delta \theta},
    \end{aligned}
    \right\}
\end{equation}
for $i = 0,1, \dots, N-1$.
To perform the time integration, we use the ERK4 method.
This method is particularly effective for time-stepping and is an alternative approach to traditional time integration schemes.
The ERK4 method provides higher accuracy in time while relying on the same spatial discretization as the FVM.
Substituing the spatial derivatives~\eqref{eq:discretized_LSWE_spherical} into the LSWE~\eqref{eq:linearized_LSWE_spherical} gives the system of ODEs:
\begin{equation}\label{eq:ODE_LSWE_spherical}
    \left.
    \begin{aligned}
        \frac{d h'}{dt} &= -\frac{h_0}{r \cos\phi} \frac{u_{i+1} - u_{i-1}}{2 \Delta \theta}, \\
        \frac{d u}{dt} &= -\frac{g}{r \cos\phi} \frac{h'_{i+1} - h'_{i-1}}{2 \Delta \theta},
    \end{aligned}
    \right\}
\end{equation}
for $i = 0,1, \dots, N-1$.
Hence, we can write the 1D spherical LSWE in the form of the IVP~\eqref{eq:IVP} by defining 
\begin{align}\label{eq:IVP_LSWE_spherical}
    y(t) = \begin{bmatrix}
        h' \\ u
    \end{bmatrix},
    \quad 
    f(y(t),t) = \begin{bmatrix}
        -\frac{h_0}{r \cos\phi} \frac{u_{i+1} - u_{i-1}}{2 \Delta \theta} \\ -\frac{g}{r \cos\phi} \frac{h'_{i+1} - h'_{i-1}}{2 \Delta \theta}
    \end{bmatrix}
    \quad \text{for } i = 0,1, \dots, N-1. 
\end{align}
As we consider a circle as the domain, we must impose periodic boundary conditions.
We do this by setting $h'_{-1} = h'_{N-1}$, $h'_{N} = h'_0$, $u_{-1} = u_{N-1}$, and $u_{N} = u_0$.
The inital conditions for $y(t)$ in~\eqref{eq:IVP_LSWE_spherical} are a Gaussian function in water height and zero velocity:
\begin{align}
    y(t_0) = y_0 = \begin{bmatrix}
        \exp(-\frac{{(\theta_{i} - \theta_0)}^2}{\sigma}) \\ 0
    \end{bmatrix}, \quad i = 0,1, \dots, N-1.
\end{align}
where $\theta_0$ is the center of the Gaussian, and $\sigma$ is the width of the Gaussian.
This means, that we can employ the four-stage time-stepping scheme in the ERK4 method to update the solution for $h'$ and $u$.
The final values of $h'$ and $u$ are obtained by combining the contributions from all four stages, by using the general update formula:
\begin{align*}
    \mathbf{W}_i^{n+1} = \mathbf{W}_i^n + \frac{\Delta t}{\Delta \theta} \frac{1}{6} \left(k_1 + 2 k_2 + 2 k_3 + k_4 \right),
\end{align*}
where the state variable
$\mathbf{W}_i = \begin{bmatrix}
    h_i' \\
    u_i
\end{bmatrix}$ represents the pertubation height and velocity at the $i'$th cell.
The intermediate stages $k_1, k_2, k_3$ and $k_4$ are computed at each time step.
The scheme integrates the equations in time while relying on flux differences to update the solution.
This approach allows the method to achieve high temporal accuracy while maintaining the spatial resolution provided by the finite volume discretization.


%The updates are:
%\begin{align*}
%    k_1 = \begin{bmatrix}
%        kh_1 \\ ku_1
%    \end{bmatrix}
%\end{align*}
%with
%\begin{subequations}
%    \begin{align}
%    kh_{1,i} &= -\frac{h_0}{r \cos\phi} \frac{u_{i+1} - u_{i-1}}{2 \Delta \theta}, \\
%    ku_{1,i} &= -\frac{g}{r \cos\phi} \frac{h'_{i+1} - h'_{i-1}}{2 \Delta \theta},
%\end{align}
%\end{subequations}
%for $i = 0, 1, \dots, N-1$. 

%The state $k_1$ is the derivative at the first stage of the ERK4 method.
%The next state $k_2$ is the estimate of the slope at the midpoint of the time interval, i.e, $t = t_n + \Delta t/2$. 
